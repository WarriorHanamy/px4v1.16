#!/bin/bash
set -e # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

# --- å‡½æ•°ï¼šæ¸…ç†åå°è¿›ç¨‹ ---
cleanup() {
    echo ""
    echo "Stopping MicroXRCEAgent..."
    kill $(jobs -p) 2>/dev/null || true
    echo "Done."
}

# è®¾ç½® Trap: å½“è„šæœ¬é€€å‡ºæˆ–æ¥æ”¶åˆ°ä¸­æ–­ä¿¡å·(Ctrl+C)æ—¶ï¼Œæ‰§è¡Œ cleanup å‡½æ•°
trap cleanup EXIT

# --- é¢„æ£€ ---
if [ ! -f "Makefile" ]; then
    echo "âŒ Error: Makefile not found. Are you in the PX4 project root?"
    exit 1
fi

# --- å‚æ•°è§£æé€»è¾‘ ---
# é»˜è®¤é…ç½®
MODEL="gz_x500"
IS_HEADLESS=1

# å¦‚æœæä¾›äº†å‚æ•° $1
if [ -n "$1" ]; then
    IS_HEADLESS=0 # æœ‰å‚æ•°åˆ™å…³é—­ Headless
    case "$1" in
        2)
            MODEL="gz_quadtailsitter"
            ;;
        *)
            MODEL="gz_x500" 
            ;;
    esac
fi

# --- æ‰§è¡Œ ---
echo "ğŸš€ Starting MicroXRCEAgent on port 8888..."
MicroXRCEAgent udp4 -p 8888 & 

echo "ğŸš Starting PX4 SITL ($MODEL) | Headless: $IS_HEADLESS"

HEADLESS=$IS_HEADLESS make px4_sitl $MODEL
